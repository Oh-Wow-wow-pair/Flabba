# 2025年9月18日 開發日誌 - 智能桌面模式問題解決

## 問題發現階段

今天用戶反映桌寵會"莫名其妙消失"，這是一個嚴重的用戶體驗問題。用戶的期望是桌寵應該只在桌面上顯示，當切換到其他應用程式時自動隱藏，但實際行為卻是桌寵在不該消失的時候消失了。

## 問題分析階段

### 技術背景回顧
在之前的開發中，我們為了解決用戶提出的需求"只希望桌寵出現在桌布上，在其他分頁時不會被渲染出來"，實現了一個基於 AppleScript 的智能桌面監聽機制。

### 問題根因分析
通過代碼審查發現了以下問題：

1. **檢測邏輯過於嚴格**
   - 原始邏輯：只有當前台應用是 "Finder" 時才顯示桌寵
   - 實際情況：用戶在 VS Code、文字編輯器等正常應用中工作時，前台應用不是 "Finder"
   - 結果：桌寵在用戶正常工作時被錯誤隱藏

2. **資源消耗問題**
   - 每 500ms 執行一次 AppleScript 查詢
   - 頻繁的系統調用造成不必要的性能開銷
   - 可能導致系統反應延遲

3. **邏輯複雜度過高**
   - 需要維護"應該隱藏桌寵的應用程式列表"
   - 難以預測所有可能的應用程式名稱
   - 增加了維護成本和出錯機率

### 核心問題識別
用戶真正需要的不是"只在 Finder 時顯示桌寵"，而是"桌寵不要干擾正常的應用程式使用"。這是兩個完全不同的需求。

## 解決方案設計

### 重新理解需求
分析用戶的真實使用場景：
- 桌寵應該像桌面裝飾一樣存在
- 不應該覆蓋或干擾其他應用程式
- 應該支持點擊穿透功能
- 在全螢幕應用時可以隱藏

### 技術方案選擇
決定放棄複雜的應用程式監聽機制，改用 Electron 原生的視窗管理功能：

1. **alwaysOnTop: false**
   - 確保桌寵不會浮在其他應用程式之上
   - 讓操作系統自然處理視窗層級

2. **visibleOnFullScreen: false**
   - 在全螢幕應用時自動隱藏桌寵
   - 滿足用戶不希望桌寵干擾全螢幕體驗的需求

3. **setIgnoreMouseEvents(true, { forward: true })**
   - 實現點擊穿透功能
   - 保持桌寵的互動性（滑鼠懸停時可互動）

## 解決方案實施

### 代碼修改步驟

1. **移除複雜的監聽機制**
   - 刪除 checkDesktopVisible 函數
   - 移除 updatePetVisibility 函數
   - 取消 startDesktopMonitoring 定時器

2. **簡化視窗配置**
   ```javascript
   // 修改前的問題配置
   alwaysOnTop: false, // 手動控制
   // 加上複雜的監聽邏輯

   // 修改後的簡潔配置
   alwaysOnTop: false, // 讓桌寵不會覆蓋其他應用程式
   visibleOnFullScreen: false, // 全螢幕時自動隱藏
   ```

3. **保留核心功能**
   - 點擊穿透功能繼續保持
   - 聊天視窗功能不受影響
   - 跨工作區顯示功能保持

### 清理無用代碼
- 移除 powerMonitor 和 exec 依賴
- 刪除 isDesktopVisible 狀態變數
- 簡化 createPetWindow 函數邏輯

## 驗證結果

### 功能驗證
1. **桌寵持續顯示**：桌寵不再莫名其妙消失
2. **不干擾應用程式**：在 VS Code、瀏覽器等應用中工作時，桌寵正確地顯示在背景
3. **點擊穿透正常**：可以正常點擊桌寵後方的桌面圖標和文件
4. **全螢幕隱藏**：在全螢幕應用時桌寵正確隱藏

### 性能改善
1. **CPU 使用率降低**：不再有定期的 AppleScript 執行
2. **記憶體佔用穩定**：移除了定時器和複雜的狀態管理
3. **啟動速度提升**：減少了初始化時的複雜邏輯

## 技術學習與反思

### 學習要點
1. **需求理解的重要性**：用戶說"只在桌布顯示"不等於"只在 Finder 前台時顯示"
2. **簡單解決方案優於複雜方案**：Electron 原生功能往往比自定義邏輯更可靠
3. **測試場景的全面性**：需要考慮用戶的真實使用場景，不只是理想化場景

### 設計原則總結
1. **優先使用平台原生功能**：操作系統的視窗管理比自定義邏輯更穩定
2. **避免過度工程化**：不是所有需求都需要複雜的技術實現
3. **性能與功能的平衡**：頻繁的系統查詢往往不是最佳解決方案

## 後續改進計劃

### 短期目標
1. 持續監控桌寵在不同應用程式下的表現
2. 收集用戶對新行為的反饋
3. 確認點擊穿透功能在各種場景下的穩定性

### 長期考慮
1. 如果確實需要更精細的顯示控制，考慮使用 Electron 的 app focus 事件
2. 研究是否可以實現更智能的桌寵互動模式
3. 探索桌寵在多顯示器環境下的行為優化

## 總結

這次問題解決的關鍵在於重新理解用戶需求和回歸技術本質。通過放棄過度複雜的自定義邏輯，轉而使用 Electron 和操作系統提供的原生功能，我們得到了一個更穩定、更高效、更符合用戶期望的解決方案。

這個案例提醒我們，在面對技術問題時，有時候最好的解決方案是簡化而不是複雜化。