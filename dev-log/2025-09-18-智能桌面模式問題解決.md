# 2025年9月18日 開發日誌 - 智能桌面模式問題解決與背景動畫優化

## 問題發現階段

### 主要問題：桌寵莫名其妙消失
發現桌寵會"莫名其妙消失"，這是一個嚴重的用戶體驗問題。期望行為是桌寵應該只在桌面上顯示，當切換到其他應用程式時自動隱藏，但實際行為卻是桌寵在不該消失的時候消失了。

### 後續問題：桌寵被遮擋時動畫暫停
解決主要問題後## 驗證結果

### 第一階段驗證：視窗管理功能
1. *## 技術學習與反思

### 學習要點
1. ## 後續改進計劃

### 短期目標
1. 持續監控桌寵## 總結

這次問題解決的關鍵在於重新理解需求和回歸技術本質。通過兩個階段的優化：

**第一階段**：放棄過度複雜的自定義邏輯，轉而使用 Electron 和操作系統提供的原生功能，得到了一個更穩定、更高效的視窗管理解決方案。

**第二階段**：解決背景動畫暫停問題，使用 setInterval 替代 requestAnimationFrame，並禁用背景節流，確保桌寵在任何情況下都能保持活力。

這個案例提醒開發過程中，在面對技術問題時，有時候最好的解決方案是簡化而不是複雜化，同時也要考慮產品的完整用戶體驗，包括那些看似邊緣的使用場景。程式下的表現
2. 收集新行為的使用體驗反饋
3. 確認點擊穿透功能在各種場景下的穩定性
4. 評估持續動畫對電池壽命的影響

### 長期考慮
1. 如果確實需要更精細的顯示控制，考慮使用 Electron 的 app focus 事件
2. 研究是否可以實現更智能的桌寵互動模式
3. 探索桌寵在多顯示器環境下的行為優化
4. 考慮實現動態幀率調整，在不同場景下平衡性能與流暢度

### 技術債務
1. 評估 setInterval 與 requestAnimationFrame 的長期性能差異
2. 考慮實現更智能的動畫暫停機制（如檢測系統電源狀態）
3. 研究是否可以實現部分動畫在背景時降級而不完全停止*："只在桌布顯示"不等於"只在 Finder 前台時顯示"
2. **簡單解決方案優於複雜方案**：Electron 原生功能往往比自定義邏輯更可靠
3. **測試場景的全面性**：需要考慮真實使用場景，不只是理想化場景
4. **動畫持續性問題**：requestAnimationFrame 在背景時會被瀏覽器優化，需要考慮替代方案

### 設計原則總結
1. **優先使用平台原生功能**：操作系統的視窗管理比自定義邏輯更穩定
2. **避免過度工程化**：不是所有需求都需要複雜的技術實現
3. **性能與功能的平衡**：頻繁的系統查詢往往不是最佳解決方案
4. **持續性考量**：桌面寵物需要持續的"生命力"，不能因為被遮擋就停止活動寵不再莫名其妙消失
2. **不干擾應用程式**：在 VS Code、瀏覽器等應用中工作時，桌寵正確地顯示在背景
3. **點擊穿透正常**：可以正常點擊桌寵後方的桌面圖標和文件
4. **全螢幕隱藏**：在全螢幕應用時桌寵正確隱藏

### 第二階段驗證：背景動畫持續性
1. **遮擋測試**：其他視窗覆蓋桌寵時，動畫持續運行
2. **移動測試**：桌寵在被遮擋時仍然正常移動和彈跳
3. **性能測試**：CPU 使用率適中，動畫流暢度保持
4. **長時間測試**：長時間被遮擋後，動畫狀態正確同步

### 性能改善
1. **CPU 使用率優化**：移除定期 AppleScript 執行，但增加持續動畫的開銷
2. **記憶體佔用穩定**：移除了定時器和複雜的狀態管理
3. **啟動速度提升**：減少了初始化時的複雜邏輯
4. **動畫流暢度**：60fps 動畫和 30fps 移動邏輯保持流暢或分頁遮住時，動畫和移動會被暫停，無法持續行動。5年9月18日 開發日誌 - 智能桌面模式問題解決

## 問題發現階段

桌寵會"莫名其妙消失"，這是一個嚴重的用戶體驗問題。用戶的期望是桌寵應該只在桌面上顯示，當切換到其他應用程式時自動隱藏，但實際行為卻是桌寵在不該消失的時候消失了。

## 問題分析階段

### 第一個問題：智能桌面監聽機制問題

#### 技術背景回顧
之前為了解決需求"只希望桌寵出現在桌布上，在其他分頁時不會被渲染出來"，實現了一個基於 AppleScript 的智能桌面監聽機制。

#### 問題根因分析
通過代碼審查發現了以下問題：

1. **檢測邏輯過於嚴格**
   - 原始邏輯：只有當前台應用是 "Finder" 時才顯示桌寵
   - 實際情況：在 VS Code、文字編輯器等正常應用中工作時，前台應用不是 "Finder"
   - 結果：桌寵在正常工作時被錯誤隱藏

2. **資源消耗問題**
   - 每 500ms 執行一次 AppleScript 查詢
   - 頻繁的系統調用造成不必要的性能開銷
   - 可能導致系統反應延遲

3. **邏輯複雜度過高**
   - 需要維護"應該隱藏桌寵的應用程式列表"
   - 難以預測所有可能的應用程式名稱
   - 增加了維護成本和出錯機率

#### 核心問題識別
真正需要的不是"只在 Finder 時顯示桌寵"，而是"桌寵不要干擾正常的應用程式使用"。這是兩個完全不同的需求。

### 第二個問題：背景動畫暫停機制

#### 問題現象
桌寵被其他視窗遮擋時，Three.js 動畫和移動邏輯會被瀏覽器暫停或降低頻率，導致桌寵看起來"死掉"了。

#### 技術原因分析
1. **requestAnimationFrame 特性**
   - 瀏覽器在視窗被遮擋時會暫停或降低 requestAnimationFrame 頻率
   - 從 60fps 降到 1fps 或完全暫停以節省資源

2. **背景節流機制**
   - Electron 預設啟用 backgroundThrottling
   - 背景視窗的 JavaScript 執行頻率被大幅降低

## 解決方案設計

### 第一個問題的解決方案：簡化視窗管理

#### 重新理解需求
分析真實使用場景：
- 桌寵應該像桌面裝飾一樣存在
- 不應該覆蓋或干擾其他應用程式
- 應該支持點擊穿透功能
- 在全螢幕應用時可以隱藏

#### 技術方案選擇
放棄複雜的應用程式監聽機制，改用 Electron 原生的視窗管理功能：

1. **alwaysOnTop: false**
   - 確保桌寵不會浮在其他應用程式之上
   - 讓操作系統自然處理視窗層級

2. **visibleOnFullScreen: false**
   - 在全螢幕應用時自動隱藏桌寵
   - 滿足不希望桌寵干擾全螢幕體驗的需求

3. **setIgnoreMouseEvents(true, { forward: true })**
   - 實現點擊穿透功能
   - 保持桌寵的互動性（滑鼠懸停時可互動）

### 第二個問題的解決方案：持續動畫機制

#### 技術方案
使用 setInterval 替代 requestAnimationFrame，並禁用背景節流：

1. **動畫循環改用 setInterval**
   ```javascript
   setInterval(animate, 16); // 約 60 FPS
   ```

2. **移動邏輯改用 setInterval**
   ```javascript
   setInterval(stepMove, 33); // 約 30 FPS
   ```

3. **禁用背景節流**
   ```javascript
   webPreferences: {
     backgroundThrottling: false
   }
   ```

## 解決方案實施

### 第一階段：視窗管理優化

#### 代碼修改步驟

1. **移除複雜的監聽機制**
   - 刪除 checkDesktopVisible 函數
   - 移除 updatePetVisibility 函數
   - 取消 startDesktopMonitoring 定時器

2. **簡化視窗配置**
   ```javascript
   // 修改前的問題配置
   alwaysOnTop: false, // 手動控制
   // 加上複雜的監聽邏輯

   // 修改後的簡潔配置
   alwaysOnTop: false, // 讓桌寵不會覆蓋其他應用程式
   visibleOnFullScreen: false, // 全螢幕時自動隱藏
   ```

3. **保留核心功能**
   - 點擊穿透功能繼續保持
   - 聊天視窗功能不受影響
   - 跨工作區顯示功能保持

#### 清理無用代碼
- 移除 powerMonitor 和 exec 依賴
- 刪除 isDesktopVisible 狀態變數
- 簡化 createPetWindow 函數邏輯

### 第二階段：背景動畫持續化

#### 代碼修改內容

1. **修改動畫循環機制**
   ```javascript
   // 修改前：使用 requestAnimationFrame（會被暫停）
   function animate() {
     // 動畫邏輯
     requestAnimationFrame(animate);
   }

   // 修改後：使用 setInterval（持續執行）
   function animate() {
     // 動畫邏輯
   }
   setInterval(animate, 16); // 約 60 FPS
   ```

2. **修改移動邏輯**
   ```javascript
   // 修改前：使用 requestAnimationFrame
   function stepMove() {
     // 移動邏輯
     requestAnimationFrame(stepMove);
   }

   // 修改後：使用 setInterval
   function stepMove() {
     // 移動邏輯
   }
   setInterval(stepMove, 33); // 約 30 FPS
   ```

3. **主進程配置更新**
   ```javascript
   webPreferences: {
     preload: path.join(__dirname, '../preload/preload.js'),
     contextIsolation: true,
     backgroundThrottling: false // 新增：防止背景時降低渲染頻率
   }
   ```

## 驗證結果

### 功能驗證
1. **桌寵持續顯示**：桌寵不再莫名其妙消失
2. **不干擾應用程式**：在 VS Code、瀏覽器等應用中工作時，桌寵正確地顯示在背景
3. **點擊穿透正常**：可以正常點擊桌寵後方的桌面圖標和文件
4. **全螢幕隱藏**：在全螢幕應用時桌寵正確隱藏

### 性能改善
1. **CPU 使用率降低**：不再有定期的 AppleScript 執行
2. **記憶體佔用穩定**：移除了定時器和複雜的狀態管理
3. **啟動速度提升**：減少了初始化時的複雜邏輯

## 技術學習與反思

### 學習要點
1. **需求理解的重要性**：用戶說"只在桌布顯示"不等於"只在 Finder 前台時顯示"
2. **簡單解決方案優於複雜方案**：Electron 原生功能往往比自定義邏輯更可靠
3. **測試場景的全面性**：需要考慮用戶的真實使用場景，不只是理想化場景

### 設計原則總結
1. **優先使用平台原生功能**：操作系統的視窗管理比自定義邏輯更穩定
2. **避免過度工程化**：不是所有需求都需要複雜的技術實現
3. **性能與功能的平衡**：頻繁的系統查詢往往不是最佳解決方案

## 後續改進計劃

### 短期目標
1. 持續監控桌寵在不同應用程式下的表現
2. 收集用戶對新行為的反饋
3. 確認點擊穿透功能在各種場景下的穩定性

### 長期考慮
1. 如果確實需要更精細的顯示控制，考慮使用 Electron 的 app focus 事件
2. 研究是否可以實現更智能的桌寵互動模式
3. 探索桌寵在多顯示器環境下的行為優化

## 總結

這次問題解決的關鍵在於重新理解用戶需求和回歸技術本質。通過放棄過度複雜的自定義邏輯，轉而使用 Electron 和操作系統提供的原生功能，我們得到了一個更穩定、更高效、更符合用戶期望的解決方案。

這個案例提醒我們，在面對技術問題時，有時候最好的解決方案是簡化而不是複雜化。