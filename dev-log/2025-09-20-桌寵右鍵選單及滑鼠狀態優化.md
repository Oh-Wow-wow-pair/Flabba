# 2025-09-20 桌寵右鍵選單及滑鼠狀態優化

## 問題背景

在開發 Flabba 桌面寵物應用時，遇到了兩個嚴重影響用戶體驗的問題：

1. **右鍵選單顯示問題**: 在 128x128px 的小視窗中，HTML 選單內容被截斷，用戶無法看到完整的選項
2. **滑鼠監控狀態混亂**: 右鍵選單關閉後，滑鼠穿透狀態未正確重置，導致後續交互失效

## 問題發現過程

### 選單顯示問題發現
在測試桌寵右鍵功能時發現：
- 右鍵彈出的 HTML 選單只顯示部分文字
- 選單項目被視窗邊界裁切
- 128x128px 的固定視窗大小無法容納完整選單內容

### 滑鼠狀態問題發現
在使用右鍵選單後發現：
- 選單關閉後無法再次觸發右鍵
- 滑鼠懸停效果失效
- 需要重新啟動應用才能恢復正常

## 問題分析

### 選單顯示問題分析
1. **空間限制**: 128x128px 視窗太小，無法顯示標準 HTML 選單
2. **佈局衝突**: HTML 選單與視窗邊界產生衝突
3. **用戶體驗**: 截斷的選單嚴重影響操作性

### 滑鼠狀態問題分析
通過添加詳細的 console.log 調試，發現問題根源：

```javascript
// 問題現象
console.log('Context menu closed, current state:', {
    isMouseEnabled: isMouseEnabled,
    isDragging: isDragging,
    mouseIgnored: mouseIgnored
});
```

發現選單關閉後：
- `mouseIgnored` 狀態未正確更新
- 事件監聽器狀態不一致
- 滑鼠穿透設定未重置

## 解決方案設計

### 選單問題解決方案
決定採用 **Electron 原生選單** 替代 HTML 選單：
- 使用 `Menu.buildFromTemplate()` 創建原生選單
- 通過 `menu.popup()` 在指定位置顯示
- 不受視窗大小限制，顯示效果完美

### 滑鼠狀態問題解決方案
設計 **雙重重置機制**：
1. 選單關閉時立即重置狀態
2. 添加 50ms 延遲的強制重置作為備用

## 具體實現步驟

### 1. 原生選單實現

在 `main.js` 中創建動態選單：

```javascript
function createContextMenu() {
    return Menu.buildFromTemplate([
        {
            label: isDragging ? '停止拖拽' : '開始拖拽',
            click: () => {
                petWindow.webContents.send('toggle-dragging');
            }
        },
        {
            label: isMouseEnabled ? '關閉滑鼠監控' : '開啟滑鼠監控',
            click: () => {
                petWindow.webContents.send('toggle-mouse');
            }
        },
        { type: 'separator' },
        {
            label: '退出',
            click: () => {
                app.quit();
            }
        }
    ]);
}
```

### 2. 選單狀態同步

實現狀態監聽機制：

```javascript
// 監聽狀態變化
ipcMain.on('state-changed', (event, { isDragging: newDragging, isMouseEnabled: newMouseEnabled }) => {
    isDragging = newDragging;
    isMouseEnabled = newMouseEnabled;
});

// 顯示選單時動態創建
ipcMain.on('show-context-menu', (event) => {
    const menu = createContextMenu();
    menu.popup({ window: petWindow });
});
```

### 3. 滑鼠狀態重置機制

實現雙重保險的重置系統：

```javascript
// 選單關閉監聽
function onContextMenuClosed() {
    console.log('Context menu closed, resetting mouse state');
    
    // 立即重置
    mouseIgnored = false;
    win.setIgnoreMouseEvents(false);
    
    // 50ms 後強制重置（備用機制）
    setTimeout(() => {
        console.log('Force reset mouse state after menu close');
        window.electronAPI.forceResetMouseState();
    }, 50);
}
```

### 4. 強制重置 API

在 `preload.js` 中添加強制重置接口：

```javascript
contextBridge.exposeInMainWorld('electronAPI', {
    forceResetMouseState: () => ipcRenderer.invoke('force-reset-mouse-state')
});
```

在 `main.js` 中處理重置請求：

```javascript
ipcMain.handle('force-reset-mouse-state', () => {
    if (petWindow) {
        petWindow.setIgnoreMouseEvents(false);
        console.log('Mouse state force reset from main process');
    }
});
```

## 測試驗證

### 選單功能測試
- 右鍵彈出原生選單：成功
- 選單項目完整顯示：成功
- 動態標籤更新：成功
- 選單功能執行：成功

### 滑鼠狀態測試
- 選單關閉後狀態重置：成功
- 重複右鍵操作：成功
- 拖拽功能恢復：成功
- 懸停效果正常：成功

## 效果分析

### 改進效果
1. **用戶體驗大幅提升**: 原生選單顯示完美，操作流暢
2. **交互穩定性增強**: 滑鼠狀態管理可靠，無需重啟應用
3. **系統整合度提高**: 原生選單與系統風格一致

### 性能影響
- 選單響應速度：從 HTML 渲染提升到原生顯示
- 記憶體使用：略微減少（移除 HTML 選單 DOM）
- CPU 負載：基本無變化

### 程式碼品質
- 移除了複雜的 HTML 選單邏輯
- 狀態管理更加清晰
- 錯誤處理機制更完善

## 技術總結

### 關鍵技術點
1. **Electron Menu API**: 實現跨平台原生選單
2. **IPC 雙向通信**: 主進程與渲染進程狀態同步
3. **事件監聽模式**: 選單生命週期管理
4. **防禦性程式設計**: 雙重重置機制防止狀態混亂

### 設計模式應用
- **觀察者模式**: 狀態變化監聽
- **工廠模式**: 動態選單創建
- **備援機制**: 多層次錯誤恢復

### 最佳實踐
1. 詳細的 console.log 調試協助問題定位
2. 漸進式解決方案：先解決核心問題，再優化細節
3. 測試驅動：每個改動都要驗證效果

## 未來優化方向

1. **選單國際化**: 支援多語言動態切換
2. **選單項目配置化**: 允許用戶自定義選單內容
3. **狀態持久化**: 記住用戶的偏好設定
4. **動畫效果**: 為狀態切換添加平滑動畫

這次優化解決了兩個關鍵的用戶體驗問題，為後續功能開發奠定了穩定的基礎。通過原生 API 的使用和完善的錯誤處理機制，應用的穩定性和用戶體驗都得到了顯著提升。