# 2025年9月18日 - 桌寵渲染系統重構與拖拽問題修復

## 問題發現

### 問題1：桌寵靜止不動
觀察到桌寵視窗出現但完全靜止，沒有預期的移動行為。初步懷疑是移動邏輯未正確執行。

### 問題2：無法拖拽互動
嘗試拖拽桌寵時發現無反應，滑鼠事件似乎被忽略。

### 問題3：拖拽時產生檔案洩漏
修復拖拽功能後，每次拖拽放開會在桌面產生.svg檔案，這是意外的副作用。

## 問題分析

### 分析1：API載入時序問題
檢查控制台發現electronAPI在script執行時尚未載入完成。原代碼直接調用window.electronAPI導致undefined錯誤，阻止了後續邏輯執行。

### 分析2：滑鼠事件被預設忽略
檢查main.js發現petWindow.setIgnoreMouseEvents(true, { forward: true })在視窗創建時就被設定，導致所有滑鼠事件被忽略。

### 分析3：圖片拖拽的瀏覽器預設行為
分析拖拽檔案產生的原因，發現是HTML中的<img>元素觸發了瀏覽器的預設拖拽行為，將圖片作為檔案拖拽到桌面。

## 解決方案

### 解決方案1：延遲啟動機制
```javascript
setTimeout(() => {
  if (window.electronAPI) {
    console.log('Starting movement...');
    setInterval(move, 50);
  } else {
    console.error('electronAPI not found');
  }
}, 500);
```
通過延遲500ms確保electronAPI完全載入。

### 解決方案2：移除預設滑鼠忽略
```javascript
// 移除此行
// petWindow.setIgnoreMouseEvents(true, { forward: true });
```
改為動態控制滑鼠穿透，只在特定條件下啟用。

### 解決方案3：多層拖拽防護
CSS層面：
```css
#pet-sprite {
  pointer-events: none;
  user-select: none;
  -webkit-user-drag: none;
}
```

JavaScript層面：
```javascript
petElement.addEventListener('mousedown', (e) => {
  e.preventDefault(); // 防止預設拖拽行為
  dragging = true;
});

petSprite.addEventListener('dragstart', (e) => {
  e.preventDefault();
  return false;
});
```

## 驗證結果

### 驗證1：移動功能恢復
測試確認桌寵能正常在螢幕上移動，邊界碰撞反彈功能正常。移動速度設定為50ms間隔，達到流暢效果。

### 驗證2：拖拽功能正常
滑鼠懸停時桌寵停止穿透模式，可以正常拖拽移動。離開後恢復穿透模式繼續自動移動。

### 驗證3：無檔案洩漏
多次測試拖拽操作，確認不再產生任何檔案到桌面。圖片元素的拖拽行為被完全阻止。

## 技術總結

這次問題解決的關鍵學習點：

1. **API載入時序至關重要**：Electron的preload腳本需要時間初始化，直接調用可能失敗。
2. **預設設定的影響範圍**：一個看似無關的setIgnoreMouseEvents設定影響了整個互動體驗。
3. **瀏覽器預設行為的副作用**：HTML元素的原生拖拽功能在桌面應用中可能產生意外結果。
4. **分層防護的必要性**：複雜的互動問題需要在多個層面（CSS、JavaScript事件）同時處理。

解決方案採用了漸進式修復策略，先解決基礎功能（移動），再處理互動功能（拖拽），最後解決副作用（檔案洩漏）。每個階段都進行了充分驗證再進入下一階段。